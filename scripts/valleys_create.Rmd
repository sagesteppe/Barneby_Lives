---
title: "Creating Named Valleys Dataset"
author: "sagesteppe"
date: "`r Sys.Date()`"
output: html_document
---

The 'Mountains Inventory version 2' dataset generated by Global Mountain Biodiversity Assessment contains a standardized naming schema for all of the worlds mountains. We are interested in developing a simpler named schema for many of the valleys and watersheds of Western North America. 

USGS Watershed Boundary Dataset (WBD) was used to identify major watersheds [The National Map](https://apps.nationalmap.gov/downloader/#/).

```{r}
library(tidyverse)
library(sf)
library(terra)
```

```{r mountains}
mtns <- st_read('../geodata/mountains/mountains.shp', quiet = T) %>% 
  st_transform(4269)
mtn_bbox <- mtns %>% 
  st_bbox()
```

```{r load watershed dataset}

pbasin <- '../geodata_raw/watershedBoundaries/WBD_National_GPKG/WBD_National_GPKG.gpkg'
st_layers(pbasin)

#hu8 <- st_read(dsn = pbasin, layer = 'WBDHU8', quiet = T)  %>% 
#  select(HU8_NAME = name) %>% 
#  st_crop(., mtn_bbox)

hu8 <- st_read(dsn = pbasin, layer = 'WBDHU10', quiet = T) %>% 
  select(HU10_NAME = name) %>% 
  st_simplify() %>% 
  st_crop(., mtn_bbox)

plot(hu8)
```

```{r}
p <- '/media/steppe/ExternalHD/SoS_GB/geodata/GNIS/NationalFile'
setwd(p)

gnis <- read.delim(file.path(p, 'NationalFile_20210825.txt'), sep = "|") %>% 
  filter(FEATURE_CLASS %in% c('Valley', 'Plain')) %>% 
  select(MAP_NAME, FEATURE_NAME, FEATURE_CLASS, PRIM_LAT_DEC, PRIM_LONG_DEC) %>% 
  st_as_sf(coords = c('PRIM_LONG_DEC', 'PRIM_LAT_DEC'), crs = 4269) %>% 
  st_crop(., mtn_bbox)

names_maybe <- st_join(hu8, gnis)
plot(gnis)
```


```{r subset valleys}

st_erase = function(x, y) st_difference(x, st_union(y)) 
output <- st_erase(hu8, mtns)

output1 <- output %>% 
  st_make_valid() %>% 
  st_cast('MULTIPOLYGON') %>% 
  st_cast('POLYGON') %>% 
  mutate(Valley = "", .before = 2)


## subset to west

states <- tigris::states() %>% 
  filter(NAME %in% c('California', 'Nevada', 'Utah', 
                     'Arizona', 'New Mexico', 'Colorado', 'Idaho', 'Washington', 'Oregon')) %>% 
  select(NAME)

out <- st_intersection(output1, states)
out <- select(out, -NAME)

```

```{r are gnis valleys useful}

#they do not appear to be useful.

gnis_sub <- gnis[ st_intersects(gnis, output) %>% lengths() > 0, ]

ggplot()+
  geom_sf(data = output) + 
  geom_sf(data = gnis_sub) 

```


```{r write out features, eval = F}

st_write(gnis_sub, '../ValleysProject/data/places/places.shp')
st_write(out, '../ValleysProject/data/valleys/valleys.shp', append = F)
```

